<?xml version="1.0" encoding="UTF-8"?>
<!--
  BUTTERFLY Common Logback Base Configuration
  
  Include this in service-specific logback.xml files:
  <include resource="logback-base.xml" />
  
  Features:
  - Structured JSON logging for Loki/ELK ingestion
  - Automatic MDC fields: traceId, spanId, tenantId, correlationId, requestId
  - Console pattern for local development
  - Profile-based appender selection
-->
<included>
    <!-- Properties -->
    <property name="LOG_PATTERN" value="%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] [%X{traceId:-}] [%X{tenantId:-}] %-5level %logger{36} - %msg%n"/>
    <property name="JSON_TIMESTAMP_PATTERN" value="yyyy-MM-dd'T'HH:mm:ss.SSSZ"/>

    <!-- Console Appender for local development -->
    <appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
        <encoder>
            <pattern>${LOG_PATTERN}</pattern>
        </encoder>
    </appender>

    <!-- JSON Appender for production (Loki/ELK compatible) -->
    <appender name="JSON" class="ch.qos.logback.core.ConsoleAppender">
        <encoder class="net.logstash.logback.encoder.LogstashEncoder">
            <timestampPattern>${JSON_TIMESTAMP_PATTERN}</timestampPattern>
            <fieldNames>
                <timestamp>@timestamp</timestamp>
                <message>message</message>
                <logger>logger</logger>
                <thread>thread</thread>
                <level>level</level>
                <stackTrace>stack_trace</stackTrace>
            </fieldNames>
            
            <!-- Include MDC fields for correlation -->
            <includeMdcKeyName>traceId</includeMdcKeyName>
            <includeMdcKeyName>spanId</includeMdcKeyName>
            <includeMdcKeyName>tenantId</includeMdcKeyName>
            <includeMdcKeyName>correlationId</includeMdcKeyName>
            <includeMdcKeyName>requestId</includeMdcKeyName>
            <includeMdcKeyName>routeId</includeMdcKeyName>
            <includeMdcKeyName>sourceId</includeMdcKeyName>
            
            <!-- Custom fields -->
            <customFields>{"application":"${APPLICATION_NAME:-unknown}","environment":"${ENVIRONMENT:-unknown}"}</customFields>
            
            <!-- Shorten stack traces -->
            <shortenedLoggerNameLength>36</shortenedLoggerNameLength>
            
            <!-- Include caller info for errors -->
            <includeCallerData>false</includeCallerData>
        </encoder>
    </appender>

    <!-- Async wrapper for JSON appender (better performance) -->
    <appender name="ASYNC_JSON" class="ch.qos.logback.classic.AsyncAppender">
        <appender-ref ref="JSON"/>
        <queueSize>512</queueSize>
        <discardingThreshold>0</discardingThreshold>
        <includeCallerData>false</includeCallerData>
        <neverBlock>true</neverBlock>
    </appender>

    <!-- Logging levels for common libraries -->
    <logger name="org.springframework" level="INFO"/>
    <logger name="org.springframework.web" level="INFO"/>
    <logger name="org.springframework.security" level="INFO"/>
    <logger name="org.springframework.kafka" level="INFO"/>
    <logger name="org.apache.kafka" level="WARN"/>
    <logger name="org.hibernate" level="WARN"/>
    <logger name="org.apache.cassandra" level="WARN"/>
    <logger name="io.netty" level="WARN"/>
    <logger name="io.lettuce" level="WARN"/>
    <logger name="io.github.resilience4j" level="INFO"/>

    <!-- BUTTERFLY packages -->
    <logger name="com.z254.butterfly" level="INFO"/>
</included>

